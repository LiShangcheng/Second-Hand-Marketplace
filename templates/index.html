<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYUäºŒæ‰‹äº¤æ˜“å¹³å°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding-bottom: 70px;
        }
        
        .navbar {
            background: #5b21b6;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .navbar h1 { font-size: 18px; }
        
        .nav-icons {
            display: flex;
            gap: 15px;
        }
        
        .nav-icons button {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            position: relative;
        }
        
        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
        }
        
        .page {
            display: none;
            min-height: calc(100vh - 200px);
        }
        
        .page.active {
            display: block;
        }
        
        .community-selector {
            background: white;
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .community-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .community-btn.active {
            background: #5b21b6;
            color: white;
            border-color: #5b21b6;
        }
        
        .search-bar {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 25px;
            font-size: 14px;
            background: #f9fafb;
        }
        
        .filter-bar {
            background: white;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .filter-chip {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 15px;
            background: white;
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-chip.active {
            background: #5b21b6;
            color: white;
            border-color: #5b21b6;
        }
        
        .listings-container {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .listing-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .listing-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .listing-image {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            text-align: center;
            padding: 10px;
        }
        
        .listing-info {
            padding: 12px;
        }
        
        .listing-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .listing-price {
            color: #dc2626;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .listing-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #6b7280;
        }
        
        .user-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e5e5;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 10px 0;
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #6b7280;
            font-size: 12px;
            text-decoration: none;
            cursor: pointer;
        }
        
        .nav-item.active {
            color: #5b21b6;
        }
        
        .nav-item span:first-child {
            font-size: 24px;
        }
        
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #5b21b6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            box-shadow: 0 4px 12px rgba(91, 33, 182, 0.4);
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 99;
        }
        
        .fab:hover {
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 12px;
            background: #5b21b6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .submit-btn:hover {
            background: #4c1d95;
        }
        
        .submit-btn.secondary {
            background: #ef4444;
        }
        
        /* æœç´¢é¡µé¢æ ·å¼ */
        .search-page {
            padding: 20px;
        }
        
        .popular-searches {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .popular-searches h3 {
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .search-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-tag {
            padding: 8px 16px;
            background: #f3f4f6;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-tag:hover {
            background: #5b21b6;
            color: white;
        }
        
        /* æ¶ˆæ¯é¡µé¢æ ·å¼ */
        .messages-page {
            padding: 20px;
        }
        
        .thread-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .thread-item {
            padding: 15px;
            border-bottom: 1px solid #e5e5e5;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .thread-item:hover {
            background: #f9fafb;
        }
        
        .thread-item:last-child {
            border-bottom: none;
        }
        
        .thread-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .thread-title {
            font-weight: 600;
            font-size: 15px;
        }
        
        .thread-time {
            font-size: 12px;
            color: #6b7280;
        }
        
        .thread-preview {
            font-size: 14px;
            color: #6b7280;
        }
        
        /* ä¸ªäººä¸­å¿ƒæ ·å¼ */
        .profile-page {
            padding: 20px;
        }
        
        .profile-header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            margin: 0 auto 15px;
        }
        
        .profile-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .profile-status {
            font-size: 14px;
            color: #6b7280;
        }
        
        .menu-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .menu-item {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e5e5;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .menu-item:hover {
            background: #f9fafb;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .menu-icon {
            font-size: 20px;
        }
        
        @media (min-width: 768px) {
            .listings-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .listings-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ğŸ“ NYUäºŒæ‰‹äº¤æ˜“</h1>
        <div class="nav-icons">
            <button onclick="showNotifications()">
                ğŸ””
                <span class="badge" id="notificationBadge" style="display: none;">0</span>
            </button>
            <button onclick="showMessages()">
                ğŸ’¬
                <span class="badge" id="messageBadge" style="display: none;">0</span>
            </button>
        </div>
    </div>

    <!-- é¦–é¡µ -->
    <div class="page active" id="homePage">
        <div class="community-selector" id="communitySelector"></div>
        <div class="search-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢è¯¾ç¨‹ä»£ç ã€ç‰©å“åç§°..." onkeyup="handleSearch(event)">
        </div>
        <div class="filter-bar" id="filterBar">
            <div class="filter-chip active" data-category="all" onclick="filterByCategory('all')">å…¨éƒ¨</div>
            <div class="filter-chip" data-category="textbook" onclick="filterByCategory('textbook')">ğŸ“š æ•™æ</div>
            <div class="filter-chip" data-category="furniture" onclick="filterByCategory('furniture')">ğŸª‘ å®¶å…·</div>
            <div class="filter-chip" data-category="electronics" onclick="filterByCategory('electronics')">ğŸ’» ç”µå­äº§å“</div>
            <div class="filter-chip" data-category="dorm_supplies" onclick="filterByCategory('dorm_supplies')">ğŸ›ï¸ å®¿èˆç”¨å“</div>
            <div class="filter-chip" data-category="other" onclick="filterByCategory('other')">ğŸ® å…¶ä»–</div>
        </div>
        <div class="listings-container" id="listingsContainer">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- æœç´¢é¡µé¢ -->
    <div class="page" id="searchPage">
        <div class="search-page">
            <!-- æœç´¢æ¡† -->
            <div style="background: white; padding: 15px 20px; margin-bottom: 20px; border-radius: 12px;">
                <input type="text" class="search-input" id="searchPageInput" placeholder="æœç´¢è¯¾ç¨‹ä»£ç ã€ç‰©å“åç§°..." onkeyup="handleSearchPageInput(event)">
            </div>
            
            <!-- æœç´¢ç»“æœ -->
            <div id="searchResultsContainer" style="display: none;">
                <div style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <h3 style="font-size: 16px; margin-bottom: 15px;">ğŸ” æœç´¢ç»“æœ</h3>
                    <div id="searchResultsList"></div>
                </div>
            </div>
            
            <!-- çƒ­é—¨æœç´¢ -->
            <div class="popular-searches" id="popularSearchesSection">
                <h3>ğŸ”¥ çƒ­é—¨æœç´¢</h3>
                <div class="search-tags" id="popularTags"></div>
            </div>
            
            <!-- æœç´¢å†å² -->
            <div class="popular-searches" id="searchHistorySection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸ“– æœç´¢å†å²</h3>
                    <button onclick="clearSearchHistory()" style="background: none; border: none; color: #6b7280; font-size: 14px; cursor: pointer;">æ¸…ç©º</button>
                </div>
                <div class="search-tags" id="historyTags">
                    <div style="color: #6b7280; font-size: 14px;">æš‚æ— æœç´¢å†å²</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯é¡µé¢ -->
    <div class="page" id="messagesPage">
        <div class="messages-page">
            <div class="thread-list" id="threadList">
                <div style="padding: 40px; text-align: center; color: #6b7280;">
                    ğŸ’¬<br>æš‚æ— æ¶ˆæ¯
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸ªäººä¸­å¿ƒé¡µé¢ -->
    <div class="page" id="profilePage">
        <div class="profile-page">
            <div class="profile-header">
                <div class="profile-avatar">ğŸ‘¤</div>
                <div class="profile-name" id="profileName">æµ‹è¯•ç”¨æˆ·</div>
                <div class="profile-status">
                    <span class="user-badge">NYUè®¤è¯</span>
                </div>
            </div>
            
            <div class="menu-list">
                <div class="menu-item" onclick="alert('æˆ‘çš„å‘å¸ƒåŠŸèƒ½å¼€å‘ä¸­...')">
                    <div class="menu-item-left">
                        <span class="menu-icon">ğŸ“¦</span>
                        <span>æˆ‘çš„å‘å¸ƒ</span>
                    </div>
                    <span>â€º</span>
                </div>
                <div class="menu-item" onclick="alert('æˆ‘çš„æ”¶è—åŠŸèƒ½å¼€å‘ä¸­...')">
                    <div class="menu-item-left">
                        <span class="menu-icon">â¤ï¸</span>
                        <span>æˆ‘çš„æ”¶è—</span>
                    </div>
                    <span>â€º</span>
                </div>
                <div class="menu-item" onclick="alert('äº¤æ˜“è®°å½•åŠŸèƒ½å¼€å‘ä¸­...')">
                    <div class="menu-item-left">
                        <span class="menu-icon">ğŸ“</span>
                        <span>äº¤æ˜“è®°å½•</span>
                    </div>
                    <span>â€º</span>
                </div>
                <div class="menu-item" onclick="alert('æˆ‘çš„è¯„ä»·åŠŸèƒ½å¼€å‘ä¸­...')">
                    <div class="menu-item-left">
                        <span class="menu-icon">â­</span>
                        <span>æˆ‘çš„è¯„ä»·</span>
                    </div>
                    <span>â€º</span>
                </div>
                <div class="menu-item" onclick="alert('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...')">
                    <div class="menu-item-left">
                        <span class="menu-icon">âš™ï¸</span>
                        <span>è®¾ç½®</span>
                    </div>
                    <span>â€º</span>
                </div>
            </div>
        </div>
    </div>

    <div class="fab" onclick="showPublishModal()">+</div>

    <div class="bottom-nav">
        <a class="nav-item active" onclick="switchTab('home')">
            <span>ğŸ </span>
            <span>é¦–é¡µ</span>
        </a>
        <a class="nav-item" onclick="switchTab('search')">
            <span>ğŸ”</span>
            <span>æœç´¢</span>
        </a>
        <a class="nav-item" onclick="switchTab('messages')">
            <span>ğŸ’¬</span>
            <span>æ¶ˆæ¯</span>
        </a>
        <a class="nav-item" onclick="switchTab('profile')">
            <span>ğŸ‘¤</span>
            <span>æˆ‘çš„</span>
        </a>
    </div>

    <div class="modal" id="publishModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">å‘å¸ƒç‰©å“</h2>
                <button class="close-btn" onclick="closeModal('publishModal')">&times;</button>
            </div>
            <form id="publishForm" onsubmit="handlePublish(event)">
                <div class="form-group">
                    <label class="form-label">ç‰©å“æ ‡é¢˜ *</label>
                    <input type="text" class="form-input" id="publishTitle" placeholder="ä¾‹å¦‚ï¼šCS-UY 1134 è¯¾æœ¬" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ç‰©å“ç±»åˆ« *</label>
                    <select class="form-select" id="publishCategory" required onchange="handleCategoryChange()">
                        <option value="">è¯·é€‰æ‹©ç±»åˆ«</option>
                        <option value="textbook">æ•™æ</option>
                        <option value="furniture">å®¶å…·</option>
                        <option value="electronics">ç”µå­äº§å“</option>
                        <option value="dorm_supplies">å®¿èˆç”¨å“</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-group" id="courseCodeGroup" style="display: none;">
                    <label class="form-label">è¯¾ç¨‹ä»£ç </label>
                    <input type="text" class="form-input" id="publishCourseCode" placeholder="ä¾‹å¦‚ï¼šCS-UY 1134">
                </div>
                <div class="form-group">
                    <label class="form-label">ä»·æ ¼ ($) *</label>
                    <input type="number" class="form-input" id="publishPrice" placeholder="0" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ç‰©å“æè¿°</label>
                    <textarea class="form-textarea" id="publishDescription" placeholder="æè¿°ç‰©å“çŠ¶å†µã€è´­ä¹°æ—¶é—´ç­‰..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">é¢äº¤åœ°ç‚¹ *</label>
                    <select class="form-select" id="publishMeetupPoint" required>
                        <option value="">è¯·é€‰æ‹©é¢äº¤åœ°ç‚¹</option>
                        <option value="Dibner Library">Dibner Library</option>
                        <option value="MetroTech Center">MetroTech Center</option>
                        <option value="Rogers Hall">Rogers Hall</option>
                        <option value="Lipton Hall">Lipton Hall</option>
                        <option value="Clark Street">Clark Street</option>
                    </select>
                </div>
                <button type="submit" class="submit-btn">å‘å¸ƒ</button>
            </form>
        </div>
    </div>

    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">å•†å“è¯¦æƒ…</h2>
                <button class="close-btn" onclick="closeModal('detailModal')">&times;</button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <script>
        const state = {
            currentCommunity: null,
            currentCategory: 'all',
            listings: [],
            communities: [],
            currentUser: { id: 1, nickname: 'æµ‹è¯•ç”¨æˆ·', verify_status: 'email_verified' }
        };

        const API_BASE_URL = '/api';

        async function initApp() {
            await loadCommunities();
            await loadListings();
            loadPopularSearches();
            renderSearchHistory(); // åŠ è½½æœç´¢å†å²
        }

        async function loadCommunities() {
            try {
                const response = await fetch(`${API_BASE_URL}/communities`);
                state.communities = response.ok ? await response.json() : getMockCommunities();
                renderCommunities();
                if (state.communities.length > 0) {
                    state.currentCommunity = state.communities[0].id;
                }
            } catch (error) {
                state.communities = getMockCommunities();
                renderCommunities();
            }
        }

        function getMockCommunities() {
            return [
                {id: 1, name: 'NYU Tandon', type: 'university'},
                {id: 2, name: 'NYU Washington Square', type: 'university'},
                {id: 3, name: 'é™„è¿‘3km', type: 'nearby'}
            ];
        }

        function renderCommunities() {
            const container = document.getElementById('communitySelector');
            container.innerHTML = state.communities.map((c, i) => `
                <button class="community-btn ${i === 0 ? 'active' : ''}" 
                        onclick="selectCommunity(${c.id})"
                        data-community="${c.id}">
                    ${c.name}
                </button>
            `).join('');
        }

        async function selectCommunity(communityId) {
            state.currentCommunity = communityId;
            document.querySelectorAll('.community-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.community == communityId);
            });
            await loadListings();
        }

        async function loadListings() {
            const container = document.getElementById('listingsContainer');
            container.innerHTML = '<div style="text-align:center;padding:20px;color:#6b7280">åŠ è½½ä¸­...</div>';
            
            try {
                const params = new URLSearchParams();
                if (state.currentCommunity) params.append('community_id', state.currentCommunity);
                if (state.currentCategory !== 'all') params.append('category', state.currentCategory);
                
                const response = await fetch(`${API_BASE_URL}/listings?${params}`);
                state.listings = response.ok ? await response.json() : getMockListings();
                renderListings();
            } catch (error) {
                state.listings = getMockListings();
                renderListings();
            }
        }

        function getMockListings() {
            return [
                {id: 1, title: 'CS-UY 1134 Introduction to Programming', price: 45, category: 'textbook', meetup_point: 'Dibner Library', user: {verify_status: 'email_verified'}},
                {id: 2, title: 'å®¿èˆæ¤…å­ ä¹æˆæ–° å¯è°ƒèŠ‚é«˜åº¦', price: 30, category: 'furniture', meetup_point: 'Lipton Hall', user: {verify_status: 'phone_verified'}},
                {id: 3, title: 'TI-84 Plus è®¡ç®—å™¨ å·¥ç¨‹è¯¾å¿…å¤‡', price: 60, category: 'electronics', meetup_point: 'MetroTech Center', user: {verify_status: 'email_verified'}},
                {id: 4, title: 'æŠ¤çœ¼å°ç¯ ä¸‰æ¡£è°ƒå…‰', price: 15, category: 'dorm_supplies', meetup_point: 'Clark Street', user: {verify_status: 'phone_verified'}},
                {id: 5, title: 'MA-UY 1024 å†å¹´è¯•å·åˆé›†', price: 10, category: 'textbook', meetup_point: 'Rogers Hall', user: {verify_status: 'email_verified'}},
                {id: 6, title: 'å°å‹å¾®æ³¢ç‚‰ 700W é€‚åˆå®¿èˆ', price: 25, category: 'electronics', meetup_point: '3rd Ave', user: {verify_status: 'phone_verified'}}
            ];
        }

        function renderListings() {
            const container = document.getElementById('listingsContainer');
            if (!state.listings.length) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280">ğŸ“¦<br>æš‚æ— å•†å“</div>';
                return;
            }
            
            const gradients = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
            ];
            
            container.innerHTML = state.listings.map((l, i) => `
                <div class="listing-card" onclick="showListingDetail(${l.id})">
                    <div class="listing-image" style="background: ${gradients[i % gradients.length]}">${l.title.substring(0, 20)}</div>
                    <div class="listing-info">
                        <div class="listing-title">${l.title}</div>
                        <div class="listing-price">${l.price}</div>
                        <div class="listing-meta">
                            <span class="user-badge">${l.user?.verify_status === 'email_verified' ? 'NYUè®¤è¯' : 'å·²è®¤è¯'}</span>
                            <span>ğŸ“ ${l.meetup_point}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function showListingDetail(listingId) {
            try {
                const response = await fetch(`${API_BASE_URL}/listings/${listingId}`);
                let listing = response.ok ? await response.json() : state.listings.find(l => l.id === listingId);
                if (!listing) return;
                
                document.getElementById('detailContent').innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div class="listing-image" style="height: 200px; border-radius: 8px;">${listing.title}</div>
                    </div>
                    <h3 style="font-size: 18px; margin-bottom: 10px;">${listing.title}</h3>
                    <div class="listing-price" style="margin-bottom: 15px;">${listing.price}</div>
                    <div style="margin-bottom: 15px;"><strong>ç‰©å“æè¿°ï¼š</strong><p style="color: #6b7280; margin-top: 5px;">${listing.description || 'ä¹æˆæ–°ï¼Œä»…ä½¿ç”¨ä¸€å­¦æœŸï¼Œæ— åˆ’ç—•å’Œç¬”è®°ã€‚'}</p></div>
                    ${listing.course_code ? `<div style="margin-bottom: 15px;"><strong>è¯¾ç¨‹ä»£ç ï¼š</strong> ${listing.course_code}</div>` : ''}
                    <div style="margin-bottom: 15px;"><strong>é¢äº¤åœ°ç‚¹ï¼š</strong> ğŸ“ ${listing.meetup_point}</div>
                    <div style="margin-bottom: 20px;"><strong>å–å®¶ï¼š</strong> <span class="user-badge">${listing.user?.verify_status === 'email_verified' ? 'NYUè®¤è¯' : 'å·²è®¤è¯'}</span></div>
                    <button class="submit-btn" onclick="contactSeller(${listing.id})">ğŸ’¬ è”ç³»å–å®¶</button>
                    <button class="submit-btn secondary" onclick="reportListing(${listing.id})">ğŸš© ä¸¾æŠ¥</button>
                `;
                document.getElementById('detailModal').classList.add('active');
            } catch (error) {
                console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        async function contactSeller(listingId) {
            alert('è”ç³»å–å®¶åŠŸèƒ½å¼€å‘ä¸­...\nå°†æ‰“å¼€ç§ä¿¡å¯¹è¯æ¡†');
            closeModal('detailModal');
        }

        async function reportListing(listingId) {
            const reason = prompt('è¯·è¾“å…¥ä¸¾æŠ¥åŸå› ï¼š');
            if (!reason) return;
            alert('ä¸¾æŠ¥æäº¤æˆåŠŸï¼æˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ã€‚');
            closeModal('detailModal');
        }

        async function filterByCategory(category) {
            state.currentCategory = category;
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.category === category);
            });
            await loadListings();
        }

        let searchTimeout;
        function handleSearch(event) {
            clearTimeout(searchTimeout);
            const query = event.target.value.trim();
            searchTimeout = setTimeout(async () => {
                if (query.length > 0) await searchListings(query);
                else await loadListings();
            }, 500);
        }

        async function searchListings(query) {
            const container = document.getElementById('listingsContainer');
            container.innerHTML = '<div style="text-align:center;padding:20px;color:#6b7280">æœç´¢ä¸­...</div>';
            
            // ä¿å­˜åˆ°æœç´¢å†å²
            if (query && query.length > 0) {
                saveToSearchHistory(query);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/listings/search?q=${encodeURIComponent(query)}`);
                state.listings = response.ok ? await response.json() : getMockListings().filter(l => 
                    l.title.toLowerCase().includes(query.toLowerCase())
                );
                renderListings();
            } catch (error) {
                state.listings = getMockListings().filter(l => l.title.toLowerCase().includes(query.toLowerCase()));
                renderListings();
            }
        }
        
        function saveToSearchHistory(query) {
            if (!query || query.trim().length === 0) return;
            
            try {
                // ä» localStorage è·å–æœç´¢å†å²
                let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
                
                // ç§»é™¤é‡å¤çš„æœç´¢è¯
                history = history.filter(item => item !== query);
                
                // æ·»åŠ åˆ°å¼€å¤´
                history.unshift(query);
                
                // åªä¿ç•™æœ€è¿‘10æ¡
                history = history.slice(0, 10);
                
                // ä¿å­˜å› localStorage
                localStorage.setItem('searchHistory', JSON.stringify(history));
                
                // æ›´æ–°æ˜¾ç¤º
                renderSearchHistory();
            } catch (error) {
                console.error('ä¿å­˜æœç´¢å†å²å¤±è´¥:', error);
            }
        }
        
        function renderSearchHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
                const container = document.getElementById('historyTags');
                
                if (!container) return;
                
                if (history.length === 0) {
                    container.innerHTML = '<div style="color: #6b7280; font-size: 14px;">æš‚æ— æœç´¢å†å²</div>';
                    return;
                }
                
                container.innerHTML = history.map(term => `
                    <div class="search-tag" onclick="searchByTag('${term.replace(/'/g, "\\'")}')">
                        ${term}
                        <span onclick="event.stopPropagation(); removeFromHistory('${term.replace(/'/g, "\\'")}')}" 
                              style="margin-left: 5px; cursor: pointer; opacity: 0.6;">Ã—</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('æ¸²æŸ“æœç´¢å†å²å¤±è´¥:', error);
            }
        }
        
        function removeFromHistory(term) {
            try {
                let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
                history = history.filter(item => item !== term);
                localStorage.setItem('searchHistory', JSON.stringify(history));
                renderSearchHistory();
            } catch (error) {
                console.error('åˆ é™¤æœç´¢å†å²å¤±è´¥:', error);
            }
        }
        
        function clearSearchHistory() {
            try {
                localStorage.removeItem('searchHistory');
                renderSearchHistory();
            } catch (error) {
                console.error('æ¸…ç©ºæœç´¢å†å²å¤±è´¥:', error);
            }
        }

        function showPublishModal() {
            document.getElementById('publishModal').classList.add('active');
        }

        function handleCategoryChange() {
            const category = document.getElementById('publishCategory').value;
            document.getElementById('courseCodeGroup').style.display = category === 'textbook' ? 'block' : 'none';
        }

        async function handlePublish(event) {
            event.preventDefault();
            const formData = {
                user_id: state.currentUser.id,
                title: document.getElementById('publishTitle').value,
                category: document.getElementById('publishCategory').value,
                price: parseFloat(document.getElementById('publishPrice').value),
                description: document.getElementById('publishDescription').value,
                meetup_point: document.getElementById('publishMeetupPoint').value,
                community_id: state.currentCommunity,
                course_code: document.getElementById('publishCourseCode').value || null
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/listings`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert('å‘å¸ƒæˆåŠŸï¼');
                    closeModal('publishModal');
                    document.getElementById('publishForm').reset();
                    await loadListings();
                } else {
                    alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                alert('å‘å¸ƒæˆåŠŸï¼');
                closeModal('publishModal');
                document.getElementById('publishForm').reset();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function switchTab(tab) {
            // æ›´æ–°åº•éƒ¨å¯¼èˆªæ çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // æ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªé¡¹å¹¶æ¿€æ´»
            const navItems = document.querySelectorAll('.nav-item');
            if (tab === 'home' && navItems[0]) navItems[0].classList.add('active');
            else if (tab === 'search' && navItems[1]) navItems[1].classList.add('active');
            else if (tab === 'messages' && navItems[2]) navItems[2].classList.add('active');
            else if (tab === 'profile' && navItems[3]) navItems[3].classList.add('active');
            
            // åˆ‡æ¢é¡µé¢æ˜¾ç¤º
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            
            if (tab === 'home') {
                document.getElementById('homePage').classList.add('active');
                loadListings();
            } else if (tab === 'search') {
                document.getElementById('searchPage').classList.add('active');
                // é‡ç½®æœç´¢é¡µé¢çŠ¶æ€
                document.getElementById('searchPageInput').value = '';
                document.getElementById('searchResultsContainer').style.display = 'none';
                document.getElementById('popularSearchesSection').style.display = 'block';
                document.getElementById('searchHistorySection').style.display = 'block';
            } else if (tab === 'messages') {
                document.getElementById('messagesPage').classList.add('active');
            } else if (tab === 'profile') {
                document.getElementById('profilePage').classList.add('active');
            }
        }

        function showNotifications() {
            alert('é€šçŸ¥åŠŸèƒ½å·²é›†æˆï¼\n\næœªè¯»é€šçŸ¥: 0\n\nç‚¹å‡»ç¡®å®šæŸ¥çœ‹æ‰€æœ‰é€šçŸ¥');
        }

        function showMessages() {
            switchTab('messages');
        }

        async function loadPopularSearches() {
            const tags = [
                'CS-UY 1134', 'MA-UY 1024', 'è®¡ç®—å™¨', 'æ¤…å­', 'Python',
                'å¾®æ³¢ç‚‰', 'iPad', 'å°ç¯', 'æ•°æ®ç»“æ„', 'æ˜¾ç¤ºå™¨'
            ];
            
            const container = document.getElementById('popularTags');
            container.innerHTML = tags.map(tag => 
                `<div class="search-tag" onclick="searchByTag('${tag}')">${tag}</div>`
            ).join('');
        }

        function searchByTag(tag) {
            document.getElementById('searchInput').value = tag;
            document.getElementById('searchPageInput').value = tag;
            
            // ä¿å­˜åˆ°æœç´¢å†å²
            saveToSearchHistory(tag);
            
            switchTab('home');
            searchListings(tag);
        }
        
        function handleSearchPageInput(event) {
            clearTimeout(searchTimeout);
            const query = event.target.value.trim();
            
            if (query.length === 0) {
                // æ˜¾ç¤ºçƒ­é—¨æœç´¢å’Œå†å²
                document.getElementById('searchResultsContainer').style.display = 'none';
                document.getElementById('popularSearchesSection').style.display = 'block';
                document.getElementById('searchHistorySection').style.display = 'block';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                await searchInSearchPage(query);
            }, 500);
        }
        
        async function searchInSearchPage(query) {
            // éšè—çƒ­é—¨æœç´¢å’Œå†å²
            document.getElementById('popularSearchesSection').style.display = 'none';
            document.getElementById('searchHistorySection').style.display = 'none';
            
            // æ˜¾ç¤ºæœç´¢ç»“æœåŒºåŸŸ
            const container = document.getElementById('searchResultsContainer');
            const resultsList = document.getElementById('searchResultsList');
            container.style.display = 'block';
            resultsList.innerHTML = '<div style="text-align:center;padding:20px;color:#6b7280">æœç´¢ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/listings/search?q=${encodeURIComponent(query)}`);
                const results = response.ok ? await response.json() : getMockListings().filter(l => 
                    l.title.toLowerCase().includes(query.toLowerCase())
                );
                
                if (results.length === 0) {
                    resultsList.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280">ğŸ“¦<br>æœªæ‰¾åˆ°ç›¸å…³å•†å“</div>';
                    return;
                }
                
                const gradients = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
                ];
                
                resultsList.innerHTML = results.map((l, i) => `
                    <div style="display: flex; gap: 15px; padding: 15px; border-bottom: 1px solid #e5e5e5; cursor: pointer; transition: background 0.2s;" 
                         onclick="showListingDetailFromSearch(${l.id})"
                         onmouseover="this.style.background='#f9fafb'" 
                         onmouseout="this.style.background='white'">
                        <div style="width: 80px; height: 80px; border-radius: 8px; background: ${gradients[i % gradients.length]}; 
                                    display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; 
                                    text-align: center; padding: 5px; flex-shrink: 0;">
                            ${l.title.substring(0, 15)}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${l.title}
                            </div>
                            <div style="color: #dc2626; font-size: 16px; font-weight: bold; margin-bottom: 5px;">
                                ${l.price}
                            </div>
                            <div style="display: flex; gap: 10px; font-size: 12px; color: #6b7280;">
                                <span class="user-badge">${l.user?.verify_status === 'email_verified' ? 'NYUè®¤è¯' : 'å·²è®¤è¯'}</span>
                                <span>ğŸ“ ${l.meetup_point}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                resultsList.innerHTML = '<div style="text-align:center;padding:20px;color:#ef4444">æœç´¢å‡ºé”™ï¼Œè¯·é‡è¯•</div>';
            }
        }
        
        function showListingDetailFromSearch(listingId) {
            showListingDetail(listingId);
        }

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) this.classList.remove('active');
            });
        });

        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>