<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二手交易平台</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/model.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') }}">
</head>
<body class="cyber-body">
    <div class="data-mesh"></div>
    <div class="scanline-overlay"></div>
    <div class="orb orb-left"></div>
    <div class="orb orb-right"></div>
    <!-- 导航栏 -->
    <div class="navbar">
        <h1 class="navbar-title">
            <span class="brand-cn">转转屋</span>
            <span class="brand-en glitch-text" data-text="Zhuan Zhuan Exchange">Zhuan Zhuan Exchange</span>
        </h1>
        <div class="nav-right">
            <div class="nav-auth" id="navAuthArea">
                <a href="{{ url_for('login_page') }}" class="auth-link">登录</a>
                <span class="divider">|</span>
                <a href="{{ url_for('register_page') }}" class="auth-link highlight">注册</a>
            </div>
            <div class="nav-icons">
                <button onclick="showNotifications()">
                    🔔
                    <span class="badge" id="notificationBadge" style="display: none;">0</span>
                </button>
                <button onclick="showMessages()">
                    💬
                    <span class="badge" id="messageBadge" style="display: none;">0</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 商城 -->
    <div class="page active" id="homePage">
        <div class="search-bar">
            <input type="text" class="search-input search-trigger" id="searchInput" 
                   placeholder="输入信号代号 / 物品编码..." 
                   onfocus="switchToSearchPage()" 
                   onclick="switchToSearchPage()" 
                   readonly>
        </div>
        <div class="neon-divider"></div>
        <div class="filter-bar" id="filterBar">
            <div class="filter-chip active" data-category="all" onclick="filterByCategory('all')">全部</div>
            <div class="filter-chip" data-category="textbook" onclick="filterByCategory('textbook')">📚 教材</div>
            <div class="filter-chip" data-category="furniture" onclick="filterByCategory('furniture')">🪑 家具</div>
            <div class="filter-chip" data-category="electronics" onclick="filterByCategory('electronics')">💻 电子产品</div>
            <div class="filter-chip" data-category="dorm_supplies" onclick="filterByCategory('dorm_supplies')">🛏️ 宿舍用品</div>
            <div class="filter-chip" data-category="rental" onclick="filterByCategory('rental')">🏢 租房</div>
            <div class="filter-chip" data-category="other" onclick="filterByCategory('other')">🎮 其他</div>
            <div class="filter-location">
                <label for="communitySelector" class="filter-location-label">地点</label>
                <div class="filter-select-wrap">
                    <select id="communitySelector" class="filter-select" onchange="handleCommunityDropdownChange(this.value)" disabled>
                        <option value="" selected>加载地点...</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="listings-container" id="listingsContainer">
            <div class="loading">加载中...</div>
        </div>
    </div>

    <!-- 搜索页面 -->
    <div class="page" id="searchPage">
        <div class="search-page">
            <!-- 搜索框 -->
            <div class="neon-panel search-card">
                <input type="text" class="search-input" id="searchPageInput" 
                       placeholder="输入信号代号 / 物品编码..." 
                       onkeyup="handleSearchPageInput(event)">
            </div>
            
            <!-- 搜索结果 -->
            <div id="searchResultsContainer" style="display: none;">
                <div class="neon-panel search-results-panel">
                    <h3 class="panel-title">🔎 信号返回</h3>
                    <div id="searchResultsList"></div>
                </div>
            </div>
            
            <!-- 热门搜索 -->
            <div class="popular-searches" id="popularSearchesSection">
                <h3>⚡ 热门信号</h3>
                <div class="search-tags" id="popularTags"></div>
            </div>
            
            <!-- 搜索历史 -->
            <div class="popular-searches" id="searchHistorySection">
                <div class="history-header">
                    <h3 class="panel-title">🧠 搜索记忆</h3>
                    <button onclick="clearSearchHistory()" class="panel-action">
                        清空
                    </button>
                </div>
                <div class="search-tags" id="historyTags">
                    <div class="muted-text">暂无搜索历史</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 讯息页面 -->
    <div class="page" id="messagesPage">
        <div class="messages-page">
            <div class="thread-list" id="threadList">
                <div class="empty-placeholder">
                    💬<br>频道静默中
                </div>
            </div>
        </div>
    </div>

    <!-- 个人中心页面 -->
    <div class="page" id="profilePage">
        <div class="profile-page">
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">
                    <img id="profileAvatarImg" class="profile-avatar-img" alt="用户头像">
                    <div class="profile-avatar-fallback" id="profileAvatarFallback">👤</div>
                    <button type="button" class="avatar-edit-btn" id="avatarEditButton" onclick="triggerAvatarUpload()" title="编辑头像">
                        ✏️
                    </button>
                    <input type="file" id="avatarUploadInput" class="avatar-input" accept="image/*" onchange="handleAvatarFileChange(event)">
                </div>
                <div class="profile-name" id="profileName">测试用户</div>
                <div class="profile-status">
                    <span class="user-badge">认证级别：ALPHA</span>
                </div>
            </div>
            <div class="neon-divider"></div>
            
            <div class="menu-list">
                <div class="menu-item" onclick="openMyListingsModal()">
                    <div class="menu-item-left">
                        <span class="menu-icon">📦</span>
                        <span>我的发布</span>
                    </div>
                    <span>›</span>
                </div>
                <div class="menu-item" onclick="openFavoritesModal()">
                    <div class="menu-item-left">
                        <span class="menu-icon">❤️</span>
                        <span>我的收藏</span>
                    </div>
                    <span>›</span>
                </div>
                <div class="menu-item" onclick="alert('交易记录功能开发中...')">
                    <div class="menu-item-left">
                        <span class="menu-icon">📝</span>
                        <span>交易记录</span>
                    </div>
                    <span>›</span>
                </div>
                <div class="menu-item" onclick="alert('我的评价功能开发中...')">
                    <div class="menu-item-left">
                        <span class="menu-icon">⭐</span>
                        <span>我的评价</span>
                    </div>
                    <span>›</span>
                </div>
                <div class="menu-item" onclick="alert('设置功能开发中...')">
                    <div class="menu-item-left">
                        <span class="menu-icon">⚙️</span>
                        <span>设置</span>
                    </div>
                    <span>›</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="bottom-nav">
        <a class="nav-item active" onclick="switchTab('home')">
            <span>🏠</span>
            <span>商城</span>
        </a>
        <a class="nav-item" onclick="switchTab('search')">
            <span>🔍</span>
            <span>搜索</span>
        </a>
        <a class="nav-item publish-item" onclick="showPublishModal()">
            <span class="publish-icon">+</span>
            <span>发布</span>
        </a>
        <a class="nav-item" onclick="switchTab('messages')">
            <span>💬</span>
            <span>讯息</span>
        </a>
        <a class="nav-item" onclick="switchTab('profile')">
            <span>👤</span>
            <span>基地</span>
        </a>
    </div>

    <!-- 发布模态框 -->
    <div class="modal" id="publishModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">发布物品</h2>
                <button class="close-btn" onclick="closeModal('publishModal')">&times;</button>
            </div>
            <form id="publishForm" onsubmit="handlePublish(event)">
                <div class="form-group">
                    <label class="form-label">物品标题 *</label>
                    <input type="text" class="form-input" id="publishTitle" 
                           placeholder="例如：CS-UY 1134 课本" required>
                </div>
                <div class="form-group">
                    <label class="form-label">物品类别 *</label>
                    <select class="form-select" id="publishCategory" required onchange="handleCategoryChange()">
                        <option value="">请选择类别</option>
                        <option value="textbook">教材</option>
                        <option value="furniture">家具</option>
                        <option value="electronics">电子产品</option>
                        <option value="dorm_supplies">宿舍用品</option>
                        <option value="rental">租房</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group" id="courseCodeGroup" style="display: none;">
                    <label class="form-label">课程代码</label>
                    <input type="text" class="form-input" id="publishCourseCode" 
                           placeholder="例如：CS-UY 1134">
                </div>
                <div class="form-group">
                    <label class="form-label">价格 ($) *</label>
                    <input type="number" class="form-input" id="publishPrice" 
                           placeholder="0" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">物品描述</label>
                    <textarea class="form-textarea" id="publishDescription" 
                              placeholder="描述物品状况、购买时间等..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">上传图片</label>
                    <input type="file" class="form-input" id="publishImages" accept="image/*" multiple>
                    <div class="form-note">支持上传多张图片（PNG/JPG/JPEG/GIF/WebP）</div>
                </div>
                <div class="form-group">
                    <label class="form-label">推荐面交地点 *</label>
                    <select class="form-select" id="publishMeetupPoint" required>
                        <option value="">请选择推荐面交地点</option>
                        <option value="Dibner Library">Dibner Library</option>
                        <option value="MetroTech Center">MetroTech Center</option>
                        <option value="Rogers Hall">Rogers Hall</option>
                        <option value="Lipton Hall">Lipton Hall</option>
                        <option value="Clark Street">Clark Street</option>
                    </select>
                </div>
                <button type="submit" class="submit-btn">发布</button>
            </form>
        </div>
    </div>

    <!-- 我的发布模态框 -->
    <div class="modal" id="myListingsModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h2 class="modal-title">我的发布</h2>
                <button class="close-btn" onclick="closeModal('myListingsModal')">&times;</button>
            </div>
            <div id="myListingsContainer" class="profile-listings">
                <div class="profile-empty">
                    <div class="empty-state-icon">🔐</div>
                    请先登录后查看你的发布
                </div>
            </div>
        </div>
    </div>

    <!-- 我的收藏模态框 -->
    <div class="modal" id="myFavoritesModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h2 class="modal-title">我的收藏</h2>
                <button class="close-btn" onclick="closeModal('myFavoritesModal')">&times;</button>
            </div>
            <div id="myFavoritesContainer" class="profile-listings">
                <div class="profile-empty">
                    <div class="empty-state-icon">🔐</div>
                    请先登录后查看你的收藏
                </div>
            </div>
        </div>
    </div>

    <!-- 商品详情模态框 -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">商品详情</h2>
                <button class="close-btn" onclick="closeModal('detailModal')">&times;</button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <!-- 讯息对话框 - 核心功能 -->
    <div class="modal" id="messageDialog">
        <div class="modal-content flex-column">
            <div class="modal-header">
                <h2 class="modal-title" id="messageDialogTitle">与卖家聊天</h2>
                <button class="close-btn" onclick="closeMessageDialog()">&times;</button>
            </div>
            
            <!-- 商品信息 -->
            <div id="messageProductInfo" class="message-product-info">
                <!-- 动态填充 -->
            </div>
            
            <!-- 讯息列表 -->
            <div id="messagesContainer" class="messages-scroll">
                <div class="loading">加载讯息中...</div>
            </div>
            
            <!-- 讯息输入框 -->
            <div class="message-input-row">
                <input type="text" id="messageInput" class="form-input" 
                       placeholder="输入讯息... (Enter 发送)">
                <button id="messageSendBtn" class="submit-btn message-send-btn" onclick="sendMessage()">
                    发送
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <!-- 基础模块 -->
    <script src="{{ url_for('static', filename='js/state.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/search.js') }}"></script>
    
    <!-- 核心功能模块 -->
    <script src="{{ url_for('static', filename='js/contact_seller.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
